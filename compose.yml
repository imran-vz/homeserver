services:
  adguard-tailscale:
    container_name: adguard-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: adguard
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/adguard:/var/lib/tailscale
      - ./config/tailscale-adguard-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  immich-tailscale:
    container_name: immich-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: immich
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      # Tailscale state on internal SSD (fast, small)
      - ./data/tailscale/immich:/var/lib/tailscale
      - ./config/tailscale-immich-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  beszel-tailscale:
    container_name: beszel-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: beszel
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/beszel:/var/lib/tailscale
      - ./config/tailscale-beszel-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  vert-tailscale:
    container_name: vert-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: vert
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/vert:/var/lib/tailscale
      - ./config/tailscale-vert-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  stirling-tailscale:
    container_name: stirling-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: stirling
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/stirling:/var/lib/tailscale
      - ./config/tailscale-stirling-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  zerobyte-tailscale:
    container_name: zerobyte-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: zerobyte
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/zerobyte:/var/lib/tailscale
      - ./config/tailscale-zerobyte-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  audiobookshelf-tailscale:
    container_name: audiobookshelf-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: audiobookshelf
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/audiobookshelf:/var/lib/tailscale
      - ./config/tailscale-audiobookshelf-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  tugtainer-tailscale:
    container_name: tugtainer-tailscale
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    hostname: tugtainer
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_ENABLE_HEALTH_CHECK=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./data/tailscale/tugtainer:/var/lib/tailscale
      - ./config/tailscale-tugtainer-serve.json:/config/serve.json:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - homelab_frontend
    restart: unless-stopped

  tugtainer-server:
    container_name: tugtainer
    image: ghcr.io/quenary/tugtainer:${TUGTAINER_VERSION:-latest}
    security_opt:
      - no-new-privileges:true
    labels:
      - dev.quenary.tugtainer.protected=true
    environment:
      - TZ=${TZ:-Asia/Kolkata}
    volumes:
      - ./data/tugtainer:/tugtainer
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - homelab_frontend
    ports:
      - "127.0.0.1:9412:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    depends_on:
      tugtainer-tailscale:
        condition: service_healthy
    restart: unless-stopped

  zerobyte-server:
    container_name: zerobyte-server
    image: ghcr.io/nicotsx/zerobyte:${ZEROBYTE_VERSION:-latest}
    security_opt:
      - no-new-privileges:true
    environment:
      - TZ=${TZ:-Asia/Kolkata}
      - APP_SECRET=${ZEROBYTE_APP_SECRET}
      - BASE_URL=${ZEROBYTE_BASE_URL}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./data/zerobyte:/var/lib/zerobyte
      # Mount external volumes for backup
      - /Volumes/SN770/homeserver-data:/mnt/homeserver-data:ro
      - /Volumes/SN770/Photos:/mnt/photos:ro
    networks:
      - homelab_frontend
    ports:
      - "127.0.0.1:4096:4096"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4096/login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 256M
    depends_on:
      zerobyte-tailscale:
        condition: service_healthy
    restart: unless-stopped

  audiobookshelf-server:
    container_name: audiobookshelf-server
    image: ghcr.io/advplyr/audiobookshelf:${AUDIOBOOKSHELF_VERSION:-latest}
    security_opt:
      - no-new-privileges:true
    volumes:
      - /Volumes/SN770/Audiobooks:/audiobooks
      - ./data/audiobookshelf/config:/config
      - ./data/audiobookshelf/metadata:/metadata
    environment:
      - TZ=${TZ:-Asia/Kolkata}
    network_mode: service:audiobookshelf-tailscale
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
        reservations:
          cpus: "0.1"
          memory: 128M
    depends_on:
      audiobookshelf-tailscale:
        condition: service_healthy
    restart: unless-stopped

  vert-server:
    container_name: vert
    image: ghcr.io/vert-sh/vert:${VERT_VERSION:-latest}
    security_opt:
      - no-new-privileges:true
    environment:
      - PUB_HOSTNAME=vert.${TS_DOMAIN}
      - PUB_ENV=production
      - PUB_DISABLE_ALL_EXTERNAL_REQUESTS=true
    networks:
      - homelab_frontend
    ports:
      - "127.0.0.1:3000:80"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 128M
    depends_on:
      vert-tailscale:
        condition: service_healthy
    restart: unless-stopped

  stirling-pdf:
    container_name: stirling-pdf
    image: stirlingtools/stirling-pdf:${STIRLING_PDF_VERSION:-latest}
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./data/stirling-pdf/tessdata:/usr/share/tessdata
      - ./data/stirling-pdf/configs:/configs
      - ./data/stirling-pdf/logs:/logs
      - ./data/stirling-pdf/pipeline:/pipeline
    environment:
      - SECURITY_ENABLELOGIN=false
      - LANGS=en_GB
      - TZ=${TZ:-Asia/Kolkata}
    networks:
      - homelab_frontend
    ports:
      - "127.0.0.1:8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/info/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 256M
    depends_on:
      stirling-tailscale:
        condition: service_healthy
    restart: unless-stopped

  beszel-server:
    container_name: beszel
    image: henrygd/beszel:${BESZEL_VERSION:-latest}
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./data/beszel:/beszel_data
      - ./data/beszel-socket:/beszel_socket
    networks:
      - homelab_frontend
    ports:
      - "127.0.0.1:8090:8090"
    healthcheck:
      test: ["CMD", "/beszel", "health", "--url", "http://localhost:8090"]
      start_period: 5s
      interval: 120s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    depends_on:
      beszel-tailscale:
        condition: service_healthy
    restart: unless-stopped

  beszel-agent:
    container_name: beszel-agent
    image: henrygd/beszel-agent:${BESZEL_AGENT_VERSION:-latest}
    network_mode: host
    volumes:
      - ./data/beszel-agent:/var/lib/beszel-agent
      - ./data/beszel-socket:/beszel_socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LISTEN: /beszel_socket/beszel.sock
      HUB_URL: ${BESZEL_HUB}
      # TOKEN and KEY will be generated in the Beszel web UI
      # Update these after adding the system in the web UI
      TOKEN: ${BESZEL_AGENT_TOKEN:-}
      KEY: ${BESZEL_AGENT_KEY:-}
    healthcheck:
      test: ["CMD", "/agent", "health"]
      interval: 120s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.05"
          memory: 32M
    depends_on:
      - beszel-server
    restart: unless-stopped

  adguard-server:
    container_name: adguard
    image: adguard/adguardhome:${ADGUARDHOME_VERSION:-latest}
    network_mode: service:adguard-tailscale
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./data/adguard/work:/opt/adguardhome/work
      - ./data/adguard/conf:/opt/adguardhome/conf
    environment:
      - TZ=${TZ:-Asia/Kolkata}
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    depends_on:
      adguard-tailscale:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  immich-server:
    container_name: immich-server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    # Note: Do NOT set user or read_only - Immich manages its own permissions
    security_opt:
      - no-new-privileges:true
    volumes:
      # Main upload location on external SSD (large storage for photos/videos)
      - /Volumes/SN770/homeserver-data/immich:/data
      # External library - read-write access to existing Photos folder
      - /Volumes/SN770/Photos:/mnt/media/photos
      # Timezone
      - /etc/localtime:/etc/localtime:ro
    environment:
      - DB_HOSTNAME=immich-postgres
      - DB_USERNAME=${DB_USERNAME:-immich}
      - DB_DATABASE_NAME=${DB_DATABASE_NAME:-immich}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOSTNAME=immich-redis
      - TZ=${TZ:-Asia/Kolkata}
    networks:
      - homelab_frontend
      - homelab_backend
    ports:
      - "127.0.0.1:2283:2283"
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      disable: false
    depends_on:
      immich-postgres:
        condition: service_healthy
      immich-redis:
        condition: service_healthy
      immich-tailscale:
        condition: service_healthy
    restart: unless-stopped

  immich-machine-learning:
    container_name: immich-machine-learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    # Note: ML container needs write access for model downloads
    security_opt:
      - no-new-privileges:true
    volumes:
      # ML cache on internal SSD (fast access for models)
      - ./data/immich-ml-cache:/cache
    environment:
      - TZ=${TZ:-Asia/Kolkata}
      - HF_HOME=/cache
      - MPLCONFIGDIR=/tmp/matplotlib
      # For Apple Silicon, use cpu provider
      - MACHINE_LEARNING_EXECUTION_PROVIDERS=cpu
    networks:
      - homelab_backend
    deploy:
      resources:
        limits:
          cpus: "6.0"
          memory: 8G
        reservations:
          cpus: "1.0"
          memory: 2G
    healthcheck:
      disable: false
    restart: unless-stopped

  immich-redis:
    container_name: immich-redis
    image: docker.io/valkey/valkey:9@sha256:fb8d272e529ea567b9bf1302245796f21a2672b8368ca3fcb938ac334e613c8f
    security_opt:
      - no-new-privileges:true
    volumes:
      # Redis data on internal SSD (fast)
      - ./data/redis:/data
    networks:
      - homelab_backend
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  immich-postgres:
    container_name: immich-postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    # Note: PostgreSQL needs to run as root initially to set up permissions
    security_opt:
      - no-new-privileges:true
    volumes:
      # Database on internal SSD (fast I/O critical for DB)
      - ./data/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME:-immich}
      POSTGRES_DB: ${DB_DATABASE_NAME:-immich}
      POSTGRES_INITDB_ARGS: "--data-checksums"
      # SSD storage - no need for HDD optimizations
    shm_size: 128mb
    networks:
      - homelab_backend
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 256M
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USERNAME:-immich} -d ${DB_DATABASE_NAME:-immich}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # jellyfin:
  #   container_name: jellyfin
  #   image: jellyfin/jellyfin:latest
  #   user: "1000:1000"
  #   read_only: true
  #   security_opt:
  #     - no-new-privileges:true
  #   cap_drop:
  #     - ALL
  #   tmpfs:
  #     - /tmp:size=512m,mode=1777
  #     - /transcode:size=4g,mode=1777
  #   volumes:
  #     # Config/cache on internal SSD (fast)
  #     - ./data/jellyfin/config:/config
  #     - ./data/jellyfin/cache:/cache
  #     # Media on external SSD - read-only
  #     - /Volumes/SN770/Movies:/media/movies:ro
  #     - /Volumes/SN770/Series:/media/tv:ro
  #   environment:
  #     - TZ=${TZ:-Asia/Kolkata}
  #     - JELLYFIN_PublishedServerUrl=http://localhost:8096
  #   networks:
  #     - homelab_frontend
  #   ports:
  #     - "127.0.0.1:8096:8096"
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: "4.0"
  #         memory: 4G
  #       reservations:
  #         cpus: "0.5"
  #         memory: 512M
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   restart: unless-stopped

# ===========================================
# NETWORKS
# ===========================================

networks:
  homelab_frontend:
    external: true
  homelab_backend:
    external: true
